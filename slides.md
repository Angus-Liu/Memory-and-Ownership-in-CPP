---
layout: cover
background: /images/background.jpg
mdc: true
duration: 35min
---

# C++ å†…å­˜ä¸æ‰€æœ‰æƒ

ä¸”å¤«å¤©åœ°ä¹‹é—´ï¼Œç‰©å„æœ‰ä¸»ï¼Œè‹Ÿéå¾ä¹‹æ‰€æœ‰ï¼Œè™½ä¸€æ¯«è€Œè«å–ã€‚â€”â€”è‹è½¼ã€Šèµ¤å£èµ‹ã€‹

<user-signature/>

---
layout: image-right
image: /images/book-cover.jpg
---

## å‚è€ƒä¹¦ç±

> [Hands-On Design Patterns with C++](https://book.douban.com/subject/37492653/)
>
> [ğŸ“– ä¸­æ–‡ç‰ˆåœ¨çº¿é˜…è¯»](https://xiaoweichen.github.io/Hands-On-Design-Patterns-with-Cpp/) ï½œ[ğŸ’» éšä¹¦æºç ](https://github.com/PacktPublishing/Hands-On-Design-Patterns-with-CPP-Second-Edition/)

**ä¸€æœ¬é¢å‘ C++ ç‰¹æ€§çš„è®¾è®¡æ¨¡å¼å®è·µæŒ‡å—**

- é’ˆå¯¹é‚£äº›æ™®éå­˜åœ¨çš„ç»å…¸è®¾è®¡æ¨¡å¼ï¼Œä»‹ç» C++ ç‰¹æœ‰çš„è§£å†³æ–¹æ¡ˆã€‚
- å±•ç¤ºå½“ä¼ ç»Ÿè®¾è®¡æŒ‘æˆ˜å‡ºç°åœ¨æ³›å‹ç¼–ç¨‹è¿™ä¸€æ–°é¢†åŸŸæ—¶ï¼Œæ‰€äº§ç”Ÿçš„ C++ ç‰¹æœ‰æ¨¡å¼å˜ä½“ã€‚
- æ›´æ–°è®¾è®¡æ¨¡å¼çŸ¥è¯†ï¼Œä¸æ—¶ä¿±è¿›ï¼Œç´§è·Ÿ C++ è¯­è¨€çš„æ¼”è¿›æ­¥ä¼ã€‚

å¸®åŠ©æˆ‘ä»¬å†™å‡º **å¯ç»´æŠ¤ï¼ˆMaintainableï¼‰ã€å¥å£®ï¼ˆRobustï¼‰ã€å¯å¤ç”¨ï¼ˆReusableï¼‰** çš„è½¯ä»¶ç³»ç»Ÿã€‚

---
layout: quote
---

## æœ¬æ¬¡åˆ†äº«æ¶µç›–ä¸»é¢˜

> ğŸ“ å‚è€ƒ [ç¬¬ 3 ç«  å†…å­˜ä¸æ‰€æœ‰æƒ](https://xiaoweichen.github.io/Hands-On-Design-Patterns-with-Cpp/3.0..html)

- ä»€ä¹ˆæ˜¯å†…å­˜/èµ„æºæ‰€æœ‰æƒï¼Ÿ
- è®¾è®¡è‰¯å¥½çš„æ‰€æœ‰æƒé•¿ä»€ä¹ˆæ ·ï¼Ÿ
- ä½•æ—¶åº”è¯¥å¯¹æ‰€æœ‰æƒâ€œæ— æ„ŸçŸ¥â€ï¼Ÿ
- å¦‚ä½•è¡¨è¾¾ **ç‹¬å ** æ‰€æœ‰æƒï¼Ÿ
- å¦‚ä½•è¡¨è¾¾ **å…±äº«** æ‰€æœ‰æƒï¼Ÿ
- å„ç§å†…å­˜æ‰€æœ‰æƒçš„æ„é€ æˆæœ¬æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ’¡ æ ¸å¿ƒç›®æ ‡ï¼šè®©è¯»ä»£ç çš„äººä¸€çœ¼çœ‹å‡ºâ€œè°æ‹¥æœ‰ï¼Œè°è´Ÿè´£â€

---
layout: section
---

## ğŸ  ä»ä¸€åº§æˆ¿å­å¼€å§‹

---
layout: two-cols-header
---

## ä»ä¸€åº§æˆ¿å­å¼€å§‹

> å†…å­˜æ ¸å¿ƒé—®é¢˜ä¸æ˜¯ `new / delete`ï¼Œè€Œæ˜¯ **â€œè°å¯¹èµ„æºçš„å­˜åœ¨è´Ÿè´£â€**

::left::

æŠŠèµ„æºæƒ³æˆä¸€å¥—æˆ¿å­ ğŸ ï¼š

ğŸ§‘â€ğŸ’¼ **æˆ¿ä¸œï¼ˆOwnerï¼‰**

- å†³å®šæ˜¯å¦æ‹¥æœ‰è¿™å¥—æˆ¿å­
- å†³å®šä»€ä¹ˆæ—¶å€™å‡ºç§Ÿã€å‡ºå”®
- å¯¹æˆ¿å­çš„**å­˜åœ¨ä¸å¤„ç½®**è´Ÿæœ€ç»ˆè´£ä»»
- å¯¹åº” C++ï¼š**èµ„æºçš„æ‰€æœ‰è€…**ï¼Œè´Ÿè´£åˆ›å»ºä¸é”€æ¯

ğŸ§ **ä½å®¢ï¼ˆUserï¼‰**

- é€šè¿‡ç§Ÿèµå…³ç³»ä½¿ç”¨æˆ¿å­
- å¯ä»¥**é€€ç§Ÿ**ï¼Œä½†ä¸èƒ½å¤„ç½®æˆ¿äº§
- å¯¹åº” C++ï¼š**èµ„æºçš„ä½¿ç”¨è€…**ï¼Œä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

::right::

âœ… æ­£ç¡®çš„ç§©åºï¼ˆç†æƒ³çŠ¶æ€ï¼‰

- æˆ¿ä¸œæ¸…æ¥šï¼š

  > â€œæˆ¿å­æ˜¯ä¸æ˜¯å­˜åœ¨ã€å½’è°ã€ä»€ä¹ˆæ—¶å€™å¤„ç½®ï¼Œç”±æˆ‘å†³å®šâ€

- ä½å®¢æ¸…æ¥šï¼š
  > â€œæˆ‘åªæ˜¯æš‚æ—¶ä½¿ç”¨ï¼Œç”¨å®Œå°±é€€ç§Ÿâ€

ğŸ“Œ **ä½¿ç”¨æƒ â‰  æ‰€æœ‰æƒ**

---

## æ··ä¹±ä»å“ªé‡Œæ¥ï¼Ÿ

- âŒ **æ²¡äººæ˜¯æˆ¿ä¸œï¼š** æˆ¿å­ä¸€ç›´å­˜åœ¨å´æ²¡äººå¤„ç½®

  > ğŸ‘‰ å¯¹åº” C++ï¼š**èµ„æºè¢«åˆ›å»ºï¼Œä½†æ²¡æœ‰æ˜ç¡®çš„ owner / memory leak**

- âŒ **å¤šä¸ªæˆ¿ä¸œï¼š** åŒä¸€å¥—æˆ¿å­è¢«åå¤å¤„ç½®

  > ğŸ‘‰ å¯¹åº” C++ï¼š**é‡å¤é‡Šæ”¾ / double free**

- âŒ **æˆ¿å­å·²å¤„ç½®ï¼Œä½å®¢è¿˜åœ¨ä½ï¼š** æ‹¿ç€æ—§é’¥åŒ™è¿›ä¸å­˜åœ¨çš„æˆ¿å­
  > ğŸ‘‰ å¯¹åº” C++ï¼š**æ‚¬ç©ºæŒ‡é’ˆ / use-after-free**

---
layout: two-cols-header
layoutClass: gap-2
---

## ä»€ä¹ˆæ˜¯å†…å­˜/èµ„æºæ‰€æœ‰æƒï¼Ÿ

```mermaid
flowchart LR
    User["User<br/>ä½¿ç”¨è€…<br/>(ä¸è´Ÿè´£é‡Šæ”¾)"]
        -- "ä¸´æ—¶ä½¿ç”¨ / è§‚å¯Ÿ / è®¿é—®" -->
    Owner["Owner<br/>ç”Ÿå‘½å‘¨æœŸè´Ÿè´£äºº"]
        -- "è´Ÿè´£ç”³è¯· / é‡Šæ”¾" -->
    Memory["Memory A<br/>ä¸€å—å…·ä½“åˆ†é…çš„å†…å­˜"]
```

::left::

### å†…å­˜æ‰€æœ‰æƒï¼ˆmemory ownershipï¼‰
= è´Ÿè´£ç®¡ç†æŸä¸ªå¯¹è±¡åŠå…¶æ‰€å å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸ

ä½†åœ¨ C++ é‡Œæˆ‘ä»¬æ›´å¸¸è¯´çš„æ˜¯ï¼š

- **å¯¹è±¡æ‰€æœ‰æƒ**ï¼ˆå¯¹è±¡æ´»å¤šä¹…ã€è°ææ„å®ƒï¼‰
- **èµ„æºæ‰€æœ‰æƒ**ï¼ˆå¯¹è±¡æ‰€æŒæœ‰çš„å†…å­˜ / é” / æ–‡ä»¶å¥æŸ„ / DB è¿æ¥ç­‰â€¦â€¦ï¼‰

> C++ çš„æƒ¯ç”¨æ³•ï¼š**è®©å¯¹è±¡æ‹¥æœ‰èµ„æº** â†’ ç®¡èµ„æºï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç®¡å¯¹è±¡

::right::

### è®¾è®¡è‰¯å¥½çš„æ‰€æœ‰æƒé•¿ä»€ä¹ˆæ ·ï¼Ÿ

ä¸€ä¸ªå¸¸è§è¯¯è§£ï¼š
> â€œç¨‹åºæ¯ä¸€å¤„éƒ½éœ€è¦çŸ¥é“è°æ‹¥æœ‰å¯¹è±¡â€

ç°å®æ›´åˆç†çš„ç›®æ ‡ï¼š

- **è¦ä¹ˆ**æ¸…æ¥šæˆ‘æ˜¯å¦ä¼šæ”¹å˜æ‰€æœ‰æƒ
- **è¦ä¹ˆ**æ¸…æ¥šæˆ‘å®Œå…¨ä¸å‚ä¸æ‰€æœ‰æƒï¼ˆåªæ˜¯ä½¿ç”¨è€…ï¼‰

---
layout: two-cols-header
layoutClass: gap-2
---

## å¥½çš„æ‰€æœ‰æƒ

::left::

ğŸ‘€ æˆ‘åªæ˜¯ä½¿ç”¨è€…ï¼Œä¸å…³å¿ƒè°æ˜¯ owner

```cpp
struct MyValues { long a, b, c, d; };

void Reset(MyValues* v) {
  // ä¸å…³å¿ƒ v çš„æ‰€æœ‰è€…æ˜¯è°ï¼Œåªè¦ä¸æç ´åå³å¯
  // æˆ‘ä¸åˆ é™¤ vï¼Œä¹Ÿä¸å»¶é•¿ v çš„ç”Ÿå‘½å‘¨æœŸ
  v->a = v->b = v->c = v->d = 0;
```

ğŸ«´ æˆ‘æ‹¿èµ°ç‹¬å æ‰€æœ‰æƒï¼Œä½†ä¸å¿…çŸ¥é“ä»è°é‚£é‡Œæ‹¿çš„

```cpp
class A {
public:
  // æ„é€ å‡½æ•°è½¬ç§»æ‰€æœ‰æƒï¼Œæ— è®ºåŸæ‰€æœ‰è€…æ˜¯è°
  // ä¸éœ€è¦çŸ¥é“â€œä¹‹å‰è°æ‹¥æœ‰â€ï¼Œåªéœ€è¦çŸ¥é“â€œç°åœ¨æˆ‘æ‹¥æœ‰â€
  A(std::vector<int>&& v) : v_(std::move(v)) {}
private:
  std::vector<int> v_;
};
```

::right::

ğŸ¤ å…±äº«æ‰€æœ‰æƒçš„è¦ç‚¹ä¹Ÿæ˜¯ä¸éœ€è¦çŸ¥é“å…¶ä»– owner

```cpp
class A {
public:
  // ä¸çŸ¥é“è°æ‹¥æœ‰ vï¼Œä¹Ÿä¸å…³å¿ƒ
  A(std::shared_ptr<std::vector<int>> v) : v_(v) {}
private:
  // ä¸ä»»æ„æ•°é‡çš„æ‰€æœ‰è€…å…±äº«æ‰€æœ‰æƒ
  std::shared_ptr<std::vector<int>> v_;
};
```

ğŸ§¹ åœ¨è¿™æ®µä»£ç é‡Œï¼Œæˆ‘æ˜ç¡®è´Ÿè´£é‡Šæ”¾

```cpp
std::unique_ptr<Widget> MakeWidget();

void Use() {
  auto w = MakeWidget();
  // æˆ‘æ¸…æ¥šåœ°çŸ¥é“è‡ªå·±è´Ÿè´£ Widget çš„ç”Ÿå‘½å‘¨æœŸ
  DoSomething(w.get()); // ä»…ä¼ é€’ä½¿ç”¨æƒ
}
```

---
layout: image-right
image: /images/girl.jpeg
---

## ğŸ˜Š å¥½çš„æ‰€æœ‰æƒ - å››æ¡æ ‡å‡†

1. **ä¸æ”¹å˜**æ‰€æœ‰æƒï¼šå¯¹ä½¿ç”¨è€…/å®ç°è€…éƒ½æ¸…æ™°
2. **è·å–ç‹¬å **æ‰€æœ‰æƒï¼šå¯¹ä½¿ç”¨è€…æ¸…æ™°ï¼ˆå¹¶èƒ½å†™å‡ºæ­£ç¡®é‡Šæ”¾é€»è¾‘ï¼‰
3. **å…±äº«**æ‰€æœ‰æƒï¼šå¯¹ä½¿ç”¨è€…æ¸…æ™°ï¼ˆè¯»ä»£ç çš„äººä¸€çœ¼å°±èƒ½çœ‹å‡ºï¼‰
4. æ¯ä¸ªå¯¹è±¡åœ¨æ¯æ®µä»£ç é‡Œéƒ½**æ˜ç¡®**ï¼ˆä¸é çº¦å®šã€ä¸é è®°å¿†ã€ä¸é çŒœï¼‰**æ˜¯å¦è´Ÿè´£**åˆ é™¤/é‡Šæ”¾å¯¹è±¡

---
layout: two-cols-header
layoutClass: gap-2
---

## åçš„æ‰€æœ‰æƒ

::left::

â“ä»æ¥å£è¯»ä¸å‡ºæ‰€æœ‰æƒè§„åˆ™

```cpp
// è°è´Ÿè´£ deleteï¼Ÿ
// æ€ä¹ˆ deleteï¼Ÿï¼ˆnew/deleteï¼Ÿmalloc/freeï¼Ÿè‡ªå®šä¹‰ allocatorï¼Ÿï¼‰
// å·¥å‚ä¼šä¸ä¼šè‡ªå·±å›æ”¶ï¼Ÿ
Widget* w = MakeWidget();
```

ğŸ­ å·¥å‚æ¨¡å¼é‡Œæœ€å±é™©çš„â€œæ‚¬ç–‘å‰§â€

```cpp
// Factory ææ„æ—¶ä¼šä¸ä¼šåˆ  wï¼Ÿ
// ä½¿ç”¨è€…åˆ äº†ä¼šä¸ä¼š double freeï¼Ÿ
// è°éƒ½ä¸åˆ ä¼šä¸ä¼š leakï¼Ÿ
WidgetFactory WF;
Widget* w = WF.MakeAnother();
```

::right::

ğŸ­ å˜å½¢æœ¯ï¼šæ‰€æœ‰æƒåˆ°åº•æœ‰æ²¡æœ‰è¢«åæ‰ï¼Ÿ

```cpp
Widget* w = MakeWidget();
// ransmogrify åˆ äº† w â†’ w æˆæ‚¬ç©ºæŒ‡é’ˆ
// Transmogrify æ²¡åˆ  wï¼Œä½†ä½ ä»¥ä¸ºåˆ äº† â†’ æ³„æ¼
Widget* w1 = Transmogrify(w);
```

ğŸ™… åé¢æ•™æï¼šshared_ptr ä¸æ˜¯â€œå…æ­»é‡‘ç‰Œâ€

```cpp
// Double å¹¶ä¸è¯•å›¾å»¶é•¿è¯¥vectorçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿä¸ä¼šå°†å…¶æ‰€æœ‰æƒè½¬ç§»ï¼›
// åªæ˜¯ä¿®æ”¹äº†è°ƒç”¨è€…ä¼ å…¥çš„vectorã€‚
void Double(std::shared_ptr<std::vector<int>> v) {
  for (auto& x : *v) x *= 2;
}
```

---
layout: section
---

## ğŸ¤” C++ å¦‚ä½•è¡¨è¾¾æ‰€æœ‰æƒ


---

## éæ‰€æœ‰æƒï¼ˆNon-owningï¼‰

- æœ€å¸¸è§ï¼šå¤§éƒ¨åˆ†ä»£ç åªâ€œä½¿ç”¨èµ„æºâ€ï¼Œä¸â€œç®¡ç†èµ„æºâ€ã€‚
  è¡¨è¾¾æ–¹å¼ï¼šåŸå§‹æŒ‡é’ˆ T*ã€å¼•ç”¨ T&

  ```cpp
  void Transmogrify(Widget* w); // æˆ‘ä¸ä¼š delete w
  void MustTransmogrify(Widget& w); // æˆ‘ä¹Ÿä¸ä¼š
  ```

- éæ‰€æœ‰æƒçš„æˆå‘˜æŒ‡é’ˆï¼šæˆ‘å¼•ç”¨å®ƒï¼Œä½†æˆ‘ä¸è´Ÿè´£å®ƒçš„ç”Ÿæ­»

  ```cpp
  class WidgetProcessor {
  public:
    WidgetProcessor(Widget* w) : w_(w) {}
    ~WidgetProcessor() {} // ç»ä¸åˆ é™¤ w_
  private:
    Widget* w_; // éæ‹¥æœ‰
  };
  ```

  çœ‹åˆ° raw pointer â†’ é»˜è®¤ç†è§£ä¸ºâ€œéæ‹¥æœ‰â€

  å‰æï¼šæ•´ä¸ªä»£ç åº“éµå¾ªä¸€è‡´çº¦å®šï¼ˆå¦åˆ™å®¹æ˜“æ··æ·†ï¼‰

---

## ç‹¬å æ‰€æœ‰æƒï¼ˆExclusive ownershipï¼‰

- æœ€ä¼˜å…ˆç”¨â€œæ ˆå˜é‡â€

  ```cpp
  void Work() {
    Widget w;        // ç‹¬å ï¼šä½œç”¨åŸŸç»“æŸè‡ªåŠ¨ææ„
    Transmogrify(&w);
    Draw(&w);
  }
  ```
  æœ€æ¸…æ™°ã€æœ€å®‰å…¨ã€æœ€ä¾¿å®œ

- å½“å¿…é¡»ä¸Šå †ï¼šç”¨ unique_ptr è¡¨è¾¾ç‹¬å 

  ```cpp
  class FancyWidget : public Widget { /*...*/ };

  // unique_ptr çš„æˆæœ¬æ¥è¿‘ raw pointerï¼›ç”Ÿå‘½å‘¨æœŸè§„åˆ™æ¸…æ™°ï¼šç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
  std::unique_ptr<Widget> w(new FancyWidget);
  ```

  å…¸å‹åŸå› ï¼šéœ€è¦è·¨ä½œç”¨åŸŸå­˜æ´»ï¼›å¤šæ€ï¼ˆåŸºç±»æŒ‡é’ˆæŒ‡å‘æ´¾ç”Ÿå¯¹è±¡ï¼‰ï¼›å¯¹è±¡å¤ªå¤§ï¼ˆæ ˆç©ºé—´æœ‰é™ï¼Œçº¿ç¨‹æ ˆå¯èƒ½åªæœ‰ 2MB~10MBï¼‰

---
layout: two-cols-header
layoutClass: gap-2
---

## ç‹¬å æ‰€æœ‰æƒçš„è½¬ç§»

::left::

ğŸ¥˜ å·¥å‚å‡½æ•°å¿…é¡»â€œé€¼è¿«æ¥é”…â€
- åè®¾è®¡ï¼šå·¥å‚è¿”å› `Widget*`
- å¥½è®¾è®¡ï¼šå·¥å‚è¿”å› `std::unique_ptr<Widget>`

```cpp
std::unique_ptr<Widget> WidgetFactory() {
  Widget* new_w = new Widget;
  return std::unique_ptr<Widget>(new_w);
}
```

âœ… æ”¶ç›Šï¼šç¼–è¯‘æœŸå¼ºåˆ¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»æ¥ç®¡æ‰€æœ‰æƒï¼›é¿å…â€œæ²¡äººæ‹¥æœ‰ â†’ æ³„æ¼â€çš„éšå½¢ bugã€‚

ğŸ¤” unique_ptr ä¸ºä»€ä¹ˆèƒ½â€œè½¬ç§»â€ï¼Ÿ

å› ä¸ºå®ƒæ˜¯å¯ç§»åŠ¨ï¼ˆmoveï¼‰çš„ï¼Œmove å‘ç”Ÿæ—¶æ‰€æœ‰æƒä» A â†’ Bï¼Œè¢« move çš„æŒ‡é’ˆè¿›å…¥â€œç©º/å·²ç§»åŠ¨çŠ¶æ€â€ï¼Œä¸ä¼šå† delete åŸå¯¹è±¡ã€‚

::right::

ğŸ” æ ˆå¯¹è±¡çš„â€œæ‰€æœ‰æƒè½¬ç§»â€ï¼šç”¨å³å€¼å¼•ç”¨ + std::move æ˜ç¤º

```cpp
void Consume(Widget&& w) {
  auto my_w = std::move(w);
  // ...
}

Widget w, w1;
Consume(std::move(w)); // æ˜¾å¼æ”¾å¼ƒæ‰€æœ‰æƒ
Consume(w1);           // ç¼–è¯‘å¤±è´¥ï¼šä½ å¿…é¡»æ˜ç¡®åŒæ„ move
```

âœ… è¦ç‚¹ï¼šstd::move çš„ä»·å€¼è®©â€œäº¤å‡ºæ‰€æœ‰æƒâ€è¿™ä»¶äº‹åœ¨ä»£ç ä¸Šå¯è§ï¼Œé¿å…è°ƒç”¨çœ‹èµ·æ¥åƒæ™®é€šè°ƒç”¨ï¼Œå´å·å·æŠŠå¯¹è±¡æç©ºã€‚

---
layout: two-cols-header
layoutClass: gap-2
---

## å…±äº«æ‰€æœ‰æƒ

::left::

### ä»€ä¹ˆæ˜¯å…±äº«æ‰€æœ‰æƒï¼Ÿ

å¤šä¸ªå®ä½“ **å¹³ç­‰åœ°** æ‹¥æœ‰åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç”±**å¼•ç”¨è®¡æ•°**å…±åŒå†³å®šã€‚

âš ï¸ ç°å®é—®é¢˜ï¼š
- å…±äº«æ‰€æœ‰æƒ**ææ˜“è¢«è¯¯ç”¨**
- â€œä¸æƒ³å…³å¿ƒé‡Šæ”¾â€ â‰  â€œåº”è¯¥ç”¨å…±äº«æ‰€æœ‰æƒâ€

ğŸ‘‰ åœ¨è®¾è®¡è‰¯å¥½çš„ç³»ç»Ÿä¸­ï¼š
- **èµ„æºçš„æ‰€æœ‰æƒé€šå¸¸æ˜¯æ˜ç¡®ä¸”å”¯ä¸€çš„**
- è‡ªåŠ¨é‡Šæ”¾ â‰  å¿…é¡»å…±äº«ï¼ˆç‹¬å æŒ‡é’ˆ / æˆå‘˜å¯¹è±¡ / å®¹å™¨åŒæ ·èƒ½åšåˆ°ï¼‰

::right::

### åˆç†ä½¿ç”¨åœºæ™¯

- åº•å±‚æ•°æ®ç»“æ„å†…éƒ¨èŠ‚ç‚¹/è¿­ä»£å™¨éœ€è¦å»¶é•¿å…ƒç´ å¯¿å‘½
- å¹¶å‘åœºæ™¯ä¸‹ï¼Œéœ€è¦ç¡®ä¿å¯¹è±¡åœ¨æ“ä½œæœŸé—´ä¸ä¼šè¢«é‡Šæ”¾

```cpp
struct ListNode {
  T data;
  std::shared_ptr<ListNode> next, prev;
};

class ListIterator {
  std::shared_ptr<ListNode> node_;
};

class List {
  std::shared_ptr<ListNode> head_;
};
```

ğŸ˜Š å¥½å¤„ï¼šå³ä½¿åˆ—è¡¨å…ƒç´ å·²ä»åˆ—è¡¨ä¸­æ–­å¼€é“¾æ¥ï¼Œåªè¦è¿˜èƒ½é€šè¿‡è¿­ä»£å™¨è®¿é—®å®ƒï¼Œè¯¥å…ƒç´ å°±ä¼šç»§ç»­å­˜æ´»ã€‚

ğŸ˜¢ ä»£ä»·ï¼šå¼•ç”¨è®¡æ•°ç»´æŠ¤ï¼›åˆæ¬¡åˆ›å»ºéœ€è¦æ§åˆ¶å—åˆ†é…ï¼ˆå¯ç”¨ make_shared ä¼˜åŒ–ï¼‰ã€‚

---
layout: two-cols-header
layoutClass: gap-2
---

## å…±äº«æ‰€æœ‰æƒçš„ä»£ä»·ä¸é£é™©

::left::

### å¾ªç¯ä¾èµ– / å¼•ç”¨é£é™©

åŒå‘é“¾è¡¨è‹¥ next å’Œ prev éƒ½æ˜¯ shared_ptrï¼š

- ç›¸é‚»èŠ‚ç‚¹äº’ç›¸æ‹¥æœ‰
- åŒæ–¹éƒ½ä»é“¾è¡¨ä¸­åˆ é™¤ä¹Ÿä¸ä¼šé‡Šæ”¾ â†’ å†…å­˜æ³„æ¼

```mermaid
flowchart LR
A[Node prev]
B[Node next]

    A -->|shared_ptr| B
    B -->|shared_ptr| A
```

ğŸ˜± ç»“æœï¼šnext å’Œ prev çš„å¼•ç”¨è®¡æ•°æ°¸è¿œ > 0ï¼Œå†…å­˜æ°¸ç”Ÿã€‚

ğŸ˜Š è§£å†³æ–¹æ¡ˆï¼šä¸€æ–¹ä½¿ç”¨ `std::weak_ptr`ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä½†èƒ½å®‰å…¨æ¢æµ‹å¯¹è±¡æ˜¯å¦è¿˜æ´»ç€ã€‚

ğŸ‘‰ â€œæˆ‘è®¤è¯†ä½ ï¼Œä½†ä¸è´Ÿè´£ä½ â€

::right::

### æ€§èƒ½æˆæœ¬

- å¤åˆ¶/ææ„ï¼šåŸå­å¢å‡å¼•ç”¨è®¡æ•°
- æ§åˆ¶å—ï¼šé¢å¤–å†…å­˜ + åˆå§‹åŒ–æˆæœ¬
- å¹¶å‘ï¼šçº¿ç¨‹å®‰å…¨çš„å…±äº«æŒ‡é’ˆæ›´å¤æ‚ï¼Œè¿è¡Œæ—¶æˆæœ¬æ›´é«˜

### è®¾è®¡ä¿¡å·

ğŸ˜®â€ğŸ’¨ æ»¥ç”¨å¾€å¾€æ„å‘³ç€ï¼šæ‰€æœ‰æƒè®¾è®¡ä¸æ¸…æ™°

---
layout: section
---

## âš”ï¸ å®æˆ˜

---

## å®æˆ˜é¢˜ 1ï¼šæ¥å£æ˜¯å¦â€œå†™æ¸…æ¥šäº†æ‰€æœ‰æƒâ€ï¼Ÿ

ğŸ¤” ä»¥ä¸‹ä»£ç æœ‰é—®é¢˜å—ï¼Ÿ

````md magic-move
```cpp
Buffer* LoadFile(const std::string& path);

void Use() {
  auto buf = LoadFile("data.bin");
  Process(buf);
}
```
```cpp
// é—®é¢˜ï¼šè°è´Ÿè´£é‡Šæ”¾è¿”å›å€¼ï¼Ÿ
Buffer* LoadFile(const std::string& path);

void Use() {
  auto buf = LoadFile("data.bin");
  Process(buf);
  // delete ? ä¸ delete ?
}
```
````
<div v-click>

ğŸ§ é—®é¢˜åˆ†æï¼š

- è°ƒç”¨è€…å¿…é¡»å»â€œç¿»å®ç° / çœ‹æ–‡æ¡£ / é—®ä½œè€…â€
- å·¥å‚å‡½æ•° + raw pointer = æ‰€æœ‰æƒä¸é€æ˜
- å¾ˆå®¹æ˜“åœ¨é‡æ„ä¸­å¼•å…¥ï¼šæ³„æ¼ / double free / use-after-free

</div>

---

## å®æˆ˜é¢˜ 1ï¼šæ¥å£æ˜¯å¦â€œå†™æ¸…æ¥šäº†æ‰€æœ‰æƒâ€ï¼Ÿ

ğŸ¤” åº”è¯¥å¦‚ä½•ä¿®æ”¹ï¼Ÿ

````md magic-move
```cpp
// é—®é¢˜ï¼šè°è´Ÿè´£é‡Šæ”¾è¿”å›å€¼ï¼Ÿ
Buffer* LoadFile(const std::string& path);

void Use() {
  auto buf = LoadFile("data.bin");
  Process(buf);
  // delete ? ä¸ delete ?
}
```
```cpp
std::unique_ptr<Buffer> LoadFile(const std::string& path);

void Use() {
  auto buf = LoadFile("data.bin");
  Process(buf);
  // delete ? ä¸ delete ?
}
```
```cpp
std::unique_ptr<Buffer> LoadFile(const std::string& path);

void Use() {
  auto buf = LoadFile("data.bin");
  Process(buf.get()); // åªå€Ÿç”¨
} // è‡ªåŠ¨é‡Šæ”¾
```
````

<div v-click>

ğŸ˜Š ä¸ºä»€ä¹ˆè¿™æ˜¯å¥½è®¾è®¡ï¼š

- æ‰€æœ‰æƒåœ¨ç±»å‹ä¸­æ˜¾å¼è¡¨è¾¾
- è°ƒç”¨æ–¹åœ¨ç¼–è¯‘æœŸè¢«è¿«æ¥é”…
- ä¸éœ€è¦æ³¨é‡Šï¼Œä¹Ÿä¸éœ€è¦çº¦å®š

</div>

---

## å®æˆ˜é¢˜ 2ï¼šå‡½æ•°è°ƒç”¨ä¸­æ˜¯å¦â€œå·å·æ”¹å˜äº†æ‰€æœ‰æƒâ€ï¼Ÿ

ğŸ¤” ä»¥ä¸‹ä»£ç æœ‰é—®é¢˜å—ï¼Ÿ

````md magic-move
```cpp
void Register(Widget* w) {
  widgets_.push_back(std::unique_ptr<Widget>(w));
}

Widget* w = new Widget;
Register(w);
Use(w);
```
```cpp
void Register(Widget* w) {
  widgets_.push_back(std::unique_ptr<Widget>(w));
}

Widget* w = new Widget;
Register(w);
// w ç°åœ¨è¿˜æ´»ç€å—ï¼Ÿ
Use(w); // æ‚¬ç©ºæŒ‡é’ˆé£é™©
```
````

<div v-click>

ğŸ§ é—®é¢˜åˆ†æï¼š

- å‡½æ•°åã€å‚æ•°å®Œå…¨çœ‹ä¸å‡º Register ä¼šâ€œåæ‰â€æ‰€æœ‰æƒ
- è°ƒç”¨ç‚¹æå…¶å±é™©ï¼Œä½†ä»£ç çœ‹èµ·æ¥â€œå¾ˆæ­£å¸¸â€

</div>

---

## å®æˆ˜é¢˜ 2ï¼šå‡½æ•°è°ƒç”¨ä¸­æ˜¯å¦â€œå·å·æ”¹å˜äº†æ‰€æœ‰æƒâ€ï¼Ÿ

ğŸ¤” åº”è¯¥å¦‚ä½•ä¿®æ”¹ï¼Ÿ

````md magic-move
```cpp
void Register(Widget* w) {
  widgets_.push_back(std::unique_ptr<Widget>(w));
}

Widget* w = new Widget;
Register(w);
// w ç°åœ¨è¿˜æ´»ç€å—ï¼Ÿ
Use(w); // æ‚¬ç©ºæŒ‡é’ˆé£é™©
```
```cpp
void Register(std::unique_ptr<Widget> w) {
  widgets_.push_back(std::move(w));
}

Widget* w = new Widget;
Register(w);
// w ç°åœ¨è¿˜æ´»ç€å—ï¼Ÿ
Use(w); // æ‚¬ç©ºæŒ‡é’ˆé£é™©
```
```cpp
void Register(std::unique_ptr<Widget> w) {
  widgets_.push_back(std::move(w));
}

auto w = std::make_unique<Widget>();
Register(std::move(w)); // æ˜ç¡®ï¼šæˆ‘æ”¾å¼ƒæ‰€æœ‰æƒ
```
````

<div v-click>

ğŸ˜Š ä¸ºä»€ä¹ˆè¿™æ˜¯å¥½è®¾è®¡ï¼š

- `std::move` æ˜¯å¿ƒç†ç¡®è®¤æŒ‰é’®ï¼ˆä¸»åŠ¨æ”¾å¼ƒï¼‰
- è°ƒç”¨ç‚¹å¯è¯»æ€§æå¼º
- ç¼–è¯‘å™¨å¸®åŠ©ä½ é˜»æ­¢è¯¯ç”¨

</div>

---

## å®æˆ˜é¢˜ 3ï¼šshared_ptr æ˜¯â€œå…±äº«æ‰€æœ‰æƒâ€ï¼Œè¿˜æ˜¯â€œå…±äº«è¯¯è§£â€ï¼Ÿ

ğŸ¤” ä»¥ä¸‹ä»£ç æœ‰é—®é¢˜å—ï¼Ÿ

````md magic-move
```cpp
void Normalize(std::shared_ptr<Image> img) {
  img->Normalize();
}
```
```cpp
// é—®é¢˜ï¼šNormalize éœ€è¦å»¶é•¿ img çš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
void Normalize(std::shared_ptr<Image> img) {
  img->Normalize(); // åªæ˜¯ä½¿ç”¨äº† img
}
```
````

<div v-click>

ğŸ§ é—®é¢˜åˆ†æï¼š

- å‡½æ•°å¹¶æ²¡æœ‰å»¶é•¿ img çš„ç”Ÿå‘½å‘¨æœŸï¼Œå´ä¿®æ”¹äº†å¼•ç”¨è®¡æ•°
- è¯­ä¹‰è¢«æ”¾å¤§ï¼šâ€œè¿™ä¸ªå‡½æ•°æ˜¯ä¸æ˜¯è¦æ´»å¾—å¾ˆä¹…ï¼Ÿâ€

</div>

---

## å®æˆ˜é¢˜ 3ï¼šshared_ptr æ˜¯â€œå…±äº«æ‰€æœ‰æƒâ€ï¼Œè¿˜æ˜¯â€œå…±äº«è¯¯è§£â€ï¼Ÿ

ğŸ¤” åº”è¯¥å¦‚ä½•ä¿®æ”¹ï¼Ÿ

````md magic-move
```cpp
// é—®é¢˜ï¼šNormalize éœ€è¦å»¶é•¿ img çš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
void Normalize(std::shared_ptr<Image> img) {
  img->Normalize(); // åªæ˜¯ä½¿ç”¨äº† img
}
```
```cpp
// å¸¦æœ‰å…±äº«è¯­ä¹‰çš„â€œä½¿ç”¨/å€Ÿç”¨â€
void Normalize(const std::shared_ptr<Image>& img) {
  img->Normalize();
}
```
```cpp
// æˆ–è€…æ›´çº¯ç²¹çš„è¡¨è¾¾â€œåªæ˜¯ä½¿ç”¨â€ï¼Œä¸å…³å¿ƒæ‰€æœ‰æƒ
void Normalize(Image& img) {
  img.Normalize();
}
```
````

<div v-click>

ğŸ˜Š ä¸ºä»€ä¹ˆè¿™æ˜¯å¥½è®¾è®¡ï¼š

- éæ‹¥æœ‰è®¿é—®ï¼Œè¯­ä¹‰ç²¾ç¡®
- é›¶è¿è¡Œæ—¶æˆæœ¬
- è¯»è€…æ¸…æ™°åœ°çŸ¥é“ï¼Œä¸ç”¨æ‹…å¿ƒç”Ÿå‘½å‘¨æœŸå˜åŒ–

</div>

---
layout: two-cols-header
layoutClass: gap-2
---

## å®æˆ˜é¢˜ 4ï¼šè·¨å±‚å¯¹è±¡ï¼Œè°æ‰æ˜¯çœŸæ­£çš„ Ownerï¼Ÿ

::left::

ğŸ¤” ä»¥ä¸‹ä»£ç æœ‰é—®é¢˜å—ï¼Ÿ

````md magic-move
```cpp
// Model è¡¨ç¤ºä¸šåŠ¡çŠ¶æ€
class Document {
public:
  void SetDirty();
};

// View è´Ÿè´£å±•ç¤º
class DocumentView {
public:
  explicit DocumentView(const std::shared_ptr<Document>& doc)
    : doc_(doc) {}

private:
  std::shared_ptr<Document> doc_;
};

// Controller é”€æ¯ Model
DocumentController::~DocumentController()
{
  document_.reset();
}
```
```cpp
// Model è¡¨ç¤ºä¸šåŠ¡çŠ¶æ€
class Document {
public:
  void SetDirty();
};

// View è´Ÿè´£å±•ç¤º
class DocumentView {
public:
  explicit DocumentView(const std::shared_ptr<Document>& doc)
    : doc_(doc) {}

private:
  std::shared_ptr<Document> doc_;
};

// Controller é”€æ¯ Model
DocumentController::~DocumentController()
{
  document_.reset(); // ä»¥ä¸º Document ä¼šé”€æ¯ï¼Œå®é™…å´è¢« View å±‚å½±å“
}
```
````

::right::

<div v-click>

ğŸ§ é—®é¢˜åˆ†æï¼š

- DocumentView æ— æ„ä¸­æ‹¥æœ‰äº† Document
- Model ç”Ÿå‘½å‘¨æœŸ è¢« View å»¶é•¿
- Controller å·²é”€æ¯ï¼Œä½† Model ä»å­˜æ´»
- è§†å›¾å±‚å·å·å‚ä¸äº†ä¸šåŠ¡å¯¹è±¡çš„ç”Ÿæ­»å†³ç­–

</div>

---
layout: two-cols-header
layoutClass: gap-2
---

## å®æˆ˜é¢˜ 4ï¼šè·¨å±‚å¯¹è±¡ï¼Œè°æ‰æ˜¯çœŸæ­£çš„ Ownerï¼Ÿ

::left::

ğŸ¤” åº”è¯¥å¦‚ä½•ä¿®æ”¹ï¼Ÿ

````md magic-move
```cpp
// Model è¡¨ç¤ºä¸šåŠ¡çŠ¶æ€
class Document {
public:
  void SetDirty();
};

// View è´Ÿè´£å±•ç¤º
class DocumentView {
public:
  explicit DocumentView(const std::shared_ptr<Document>& doc)
    : doc_(doc) {}

private:
  std::shared_ptr<Document> doc_;
};

// Controller é”€æ¯ Model
DocumentController::~DocumentController()
{
  document_.reset(); // ä»¥ä¸º Document ä¼šé”€æ¯ï¼Œå®é™…å´è¢« View å±‚å½±å“
}
```
```cpp
// Model è¡¨ç¤ºä¸šåŠ¡çŠ¶æ€
class Document {
public:
  void SetDirty();
};

// View è´Ÿè´£å±•ç¤º
class DocumentView {
public:
  explicit DocumentView(const std::shared_ptr<Document>& doc)
    : doc_(doc) {}

private:
  std::weak_ptr<Document> doc_; // åªè§‚å¯Ÿï¼Œä¸æ‹¥æœ‰
};

// Controller é”€æ¯ Model
DocumentController::~DocumentController()
{
  document_.reset(); // Document æ­£å¸¸é”€æ¯
}
```
````

::right::

<div v-click>

ğŸ˜Š ä¸ºä»€ä¹ˆè¿™æ˜¯å¥½è®¾è®¡ï¼š

- Document çš„ Owner æ˜¯ Controller / Application
- View åªè´Ÿè´£å±•ç¤ºï¼Œä¸å†³å®šå¯¹è±¡æ˜¯å¦å­˜åœ¨
- Model é”€æ¯ â‡’ View è‡ªåŠ¨å¤±æ•ˆ
- weak_ptr æ˜ç¡®è¡¨è¾¾ä¸æŒæ§ç”Ÿå‘½å‘¨æœŸ

</div>

---

## æŠŠæ‰€æœ‰æƒå†™è¿›ç±»å‹ï¼Œè®©è¯»è€…ä¸ç”¨çŒœ

æˆ‘ä»¬åœ¨ä»£ç é‡Œéœ€è¦ **æ¸…æ™°** è¡¨è¾¾å››ä»¶äº‹ï¼šä½¿ç”¨ï¼ˆnon-owningï¼‰ã€ç‹¬å ï¼ˆexclusiveï¼‰ã€è½¬ç§»ï¼ˆmoveï¼‰ã€å…±äº«ï¼ˆsharedï¼‰

<scrollable-table maxHeight="400px" stickyHeader>

| **ä½¿ç”¨åœºæ™¯ / éœ€æ±‚** | **æ¨èç±»å‹** | **æ‰€æœ‰æƒè¯­ä¹‰ï¼ˆå·¥ç¨‹è¯»æ³•ï¼‰** |
| --- | --- | --- |
| éæ‹¥æœ‰è®¿é—®ï¼ˆå¯ç©ºï¼‰ | `T*` | **å€Ÿç”¨**ï¼šå¯¹è±¡å¿…é¡»åœ¨è°ƒç”¨æœŸé—´å­˜æ´»ï¼Œå¯ä¸ºç©º |
| éæ‹¥æœ‰è®¿é—®ï¼ˆä¸å¯ç©ºï¼‰ | `T&` | **å€Ÿç”¨**ï¼šå¯¹è±¡å¿…é¡»åœ¨è°ƒç”¨æœŸé—´å­˜æ´»ï¼Œä¸å¯ä¸ºç©º |
| ç‹¬å æ‹¥æœ‰ï¼ˆè‡ªåŠ¨å­˜å‚¨æœŸï¼‰ | `T` | **æˆ‘æ‹¥æœ‰**ï¼šä½œç”¨åŸŸç»“æŸè‡ªåŠ¨ææ„ |
| ç‹¬å æ‹¥æœ‰ï¼ˆåŠ¨æ€åˆ†é…ï¼‰ | `std::unique_ptr<T>` | **æˆ‘æ‹¥æœ‰**ï¼šè´Ÿè´£é‡Šæ”¾ï¼Œç”Ÿå‘½å‘¨æœŸæ˜ç¡® |
| ç‹¬å æ‰€æœ‰æƒè½¬ç§» | `std::unique_ptr<T>ï¼ˆmoveï¼‰/ T&& + std::move` | **æˆ‘æ”¾å¼ƒ â†’ ä½ æ¥ç®¡**ï¼šæ‰€æœ‰æƒè½¬ç§»åœ¨ä»£ç ä¸­å¯è§ |
| å…±äº«æ‹¥æœ‰ | `std::shared_ptr<T>` | **æˆ‘ä»¬å…±åŒæ‹¥æœ‰**ï¼šé€šè¿‡å¼•ç”¨è®¡æ•°ç®¡ç†ç”Ÿå‘½å‘¨æœŸ |
| å…±äº«ä½“ç³»ä¸­çš„å€Ÿç”¨ âš ï¸ | `const std::shared_ptr<T>&` | **ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä½†ä¾èµ–å…±äº«æ‰€æœ‰æƒä½“ç³»** |
| æ‰“ç ´å…±äº«ç¯ / è§‚æµ‹ | `std::weak_ptr<T>` | **åªè§‚å¯Ÿ**ï¼šä¸æ‹¥æœ‰ï¼Œä¸å»¶é•¿ç”Ÿå‘½å‘¨æœŸ |

</scrollable-table>

---
layout: intro
---

## ç»“æŸè¯­

å†…å­˜æ‰€æœ‰æƒå…¶å®æ˜¯å¯¹è±¡æ‰€æœ‰æƒçš„ç®€ç§°ï¼Œè€Œå¯¹è±¡æ‰€æœ‰æƒæ˜¯èµ„æºæ‰€æœ‰æƒçš„è½½ä½“ã€‚

ç°ä»£ C++ æä¾›äº†æˆç†Ÿçš„æƒ¯ç”¨æ³•ï¼Œè®©â€œè°è´Ÿè´£é‡Šæ”¾â€ä»æ³¨é‡Šå’Œè„‘è¡¥å˜æˆç±»å‹ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚

æ›´æœ‰æ„æ€çš„â€œå¯¹è±¡ä¸è§†å›¾â€éƒ¨åˆ†å°±ç­‰å„ä½è‡ªè¡Œæ¢ç´¢äº†ï½

è°¢è°¢ ğŸ‘‹